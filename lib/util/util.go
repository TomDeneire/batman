package util

import (
	"fmt"

	"github.com/distatus/battery"
	"github.com/webview/webview_go"
)

// Display battery info and charging advice
func Display(state string, percentage string, message string, raw bool) {

	available := "available"
	if state == "Discharging" {
		available = "remaining"
	}

	status := "BAT0: " + state + ": " + percentage + `% ` + available

	if raw {
		fmt.Println(status)
		return
	}

	w := webview.New(true)
	defer w.Destroy()
	w.SetTitle("Batman")

	svg := `<svg viewBox="0 0 750 750"  width="100" height="100">
	   <path d="M592.3,379.6c-2-33.3-4.7-66.6-8.4-99.7c-4.1-36.4-10.2-72.5-17.5-108.3c-6.8-33.2-15.3-65.8-29.2-96.9
		   c-6.9-15.5-15-30.2-28.1-41.4c-1.6-1.4-3.4-3-5.7-2.2c-2.3,0.8-2.6,3.1-2.9,5.3c-1.5,13.5-2.8,27-2.8,40.6
		   c0.2,45.9-2.8,91.5-9.7,136.9c-0.6,4.3-1.9,5.1-5.9,3.5c-25-9.9-50.9-15.4-77.8-16.2c-24.5-0.7-49.1-2-73.5,1.4
		   c-21.2,2.9-42.3,6.3-63.5,9.5c-17.6,2.7-14.2,2.8-15.8-11.2c-4.4-38.8-7.8-77.8-9.3-116.9c-0.4-10.8-0.5-21.6-2.6-32.2
		   c-0.6-3.1-1.2-6.3-4.7-7.4c-3.6-1.1-6.3,0.8-8.8,3.1c-5.5,5-9.6,11.1-13.1,17.6c-13.5,25.3-21,52.7-27.6,80.4
		   c-14.6,60.9-21.9,122.9-26.3,185.2c-3.4,47.2-5.8,94.4-4.6,151.8c2,30.4,2.1,71,6,111.4c3.2,33.7,8.9,67,15,100.3
		   c0.9,4.8,3.3,8,7.7,10c5.1,2.2,10.1,4.6,15.2,6.7c9.3,3.8,18.8,5.3,28.8,3.1c4.6-1,7.4-3.4,8.3-8.3c0.9-5,2.3-9.9,3.9-14.6
		   c5.2-15,14.4-26.5,29.9-31.5c18-5.8,36.4-6,54.7-1.8c10.2,2.3,20.1,5.8,30.1,8.7c30.5,8.9,60.5,9.2,89.9-4.7c6.3-3,13-5.4,19.5-8
		   c2.4-1,4.8-1.8,7.6-1.1c8.7,2.2,17.5,4,26.2,6.4c20.2,5.6,33.1,18.3,37,39.4c1,5.3,1.9,10.6,2.7,15.9c0.4,3,1.5,4.6,4.9,4.5
		   c5.6-0.2,11.1,0.4,16.7,0c11.3-0.8,20.5-4.6,21.5-19.8c0.1-1,0.3-1.9,0.5-2.9c4.6-30.4,8.8-60.8,11.2-91.5
		   c2.8-35.4,3.2-70.9,3.7-106.4C596.2,458.7,594.6,419.2,592.3,379.6z M342.9,546.5c-0.2,1.6-2.6,1.5-4.2,1.8
		   c-25.2,5.6-50.1,12.1-76.1,13.1c-2.9,0.1-5.6,0.3-7.6-2.1c-15.5-18.4-31.3-36.4-42.5-58c-1.9-3.6-3.7-7.3-3.6-11.6
		   c0.1-3.1,0.6-5.9,3.7-7.4c3.3-1.7,6.4-1.2,9.2,1c5.7,4.4,11.6,8.6,16.8,13.6c21,19.9,46,31.7,73.8,38.6c9,2.2,17.8,5.2,26.7,8
		   C340.8,543.9,343.3,544.3,342.9,546.5z M518.6,538.6c-5.8,7-11.7,14.1-17.4,21.2c-2.5,3.1-5.5,4.2-9.4,3.9
		   c-25.5-1.8-50.5-6.4-75-13.9c-1.7-0.5-4-0.4-5.1-3.1c12.3-4.9,24.8-7.9,37.3-11.1c23.6-5.9,44.5-16.8,62.6-33.1
		   c5.6-5.1,11.6-9.8,17.4-14.7c3.9-3.3,9.6-5.6,14-3.1C556.4,492.4,524.5,531.5,518.6,538.6z"/>
</svg>`

	html := `data:text/html,
	<!doctype html>
	<html>
		<body>
			<div style="margin:auto; width:60%;">` + svg + `</div>
			<p>
			<div>` + status + `</div>
			<div>` + message + `<div>
		<body>
	</html>`

	w.Navigate(html)
	w.Run()
}

func BatteryInfo() (string, int, error) {

	var state string
	var percentage int

	batteries, err := battery.GetAll()
	if err != nil {
		return state, percentage, fmt.Errorf("could not get battery status: %v", err)
	}

	main := batteries[0]
	state = fmt.Sprint(main.State)
	percentage = int(main.Current / main.Full * 100)

	return state, percentage, nil
}
